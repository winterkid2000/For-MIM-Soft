import os
import numpy as np
import nibabel as nib
import pydicom
import SimpleITK as sitk
from rt_utils import RTStructBuilder
import glob

def load_dicom_series(dicom_folder):
    "DICOM ì‹œë¦¬ì¦ˆ ë¡œë“œ ë° ë©”íƒ€ë°ì´í„° ì¶”ì¶œ"
    reader = sitk.ImageSeriesReader()
    dicom_files = reader.GetGDCMSeriesFileNames(dicom_folder)
    if not dicom_files:
        raise ValueError("ìœ íš¨í•œ DICOM ì‹œë¦¬ì¦ˆ ì—†ìŒ")

    reader.SetFileNames(dicom_files)
    try:
        image = reader.Execute()
    except Exception as e:
        raise RuntimeError(f"DICOM ì½ê¸° ì‹¤íŒ¨: {str(e)}")

    return image

def resample_mask_to_dicom(mask_nifti, dicom_image):
    "NIfTI ë§ˆìŠ¤í¬ë¥¼ DICOM ì¢Œí‘œê³„ë¡œ ë¦¬ìƒ˜í”Œë§"
    resampler = sitk.ResampleImageFilter()
    resampler.SetReferenceImage(dicom_image)
    resampler.SetInterpolator(sitk.sitkNearestNeighbor)
    resampler.SetTransform(sitk.Transform())
    return resampler.Execute(mask_nifti)

def validate_spatial_alignment(dicom_image, nifti_image):
    "3D ê³µê°„ ì •ë ¬ ê²€ì¦"
    dicom_origin = np.array(dicom_image.GetOrigin())
    dicom_spacing = np.array(dicom_image.GetSpacing())
    dicom_direction = np.array(dicom_image.GetDirection()).reshape(3,3)

    nifti_origin = np.array(nifti_image.GetOrigin())
    nifti_spacing = np.array(nifti_image.GetSpacing())
    nifti_direction = np.array(nifti_image.GetDirection()).reshape(3,3)

    tolerance = 1e-3

    if not np.allclose(dicom_origin, nifti_origin, atol=tolerance):
        raise ValueError(f"ì›ì  ë¶ˆì¼ì¹˜\nDICOM: {dicom_origin}\nNIfTI: {nifti_origin}")
    if not np.allclose(dicom_spacing, nifti_spacing, atol=tolerance):
        raise ValueError(f"í”½ì…€ ê°„ê²© ë¶ˆì¼ì¹˜\nDICOM: {dicom_spacing}\nNIfTI: {nifti_spacing}")
    if not np.allclose(dicom_direction, nifti_direction, atol=tolerance):
        raise ValueError(f"ë°©í–¥ ë§¤íŠ¸ë¦­ìŠ¤ ë¶ˆì¼ì¹˜\nDICOM:\n{dicom_direction}\nNIfTI:\n{nifti_direction}")

def process_pre(patient_id, ct_base, seg_base, output_base):
    dicom_path = os.path.join(ct_base, str(patient_id), "PRE")

    # segmentation ê²½ë¡œ: "1_PRE.nii", "2_PRE.nii" ë“± í´ë” ë‚´ë¶€ì—ì„œ NIfTI ê²€ìƒ‰
    seg_folder = os.path.join(seg_base, f"{patient_id}_PRE.nii")
    nii_files = glob.glob(os.path.join(seg_folder, "*.nii*"))
    if not nii_files:
        print(f"í™˜ì {patient_id} [PRE]: NIfTI íŒŒì¼ ì—†ìŒ â†’ {seg_folder}")
        return
    mask_path = nii_files[0]

    output_file = os.path.join(output_base, f"{patient_id}_PRE_rtstruct.dcm")

    try:
        if not os.path.exists(dicom_path):
            raise FileNotFoundError(f"DICOM í´ë” ì—†ìŒ: {dicom_path}")
        if not os.path.exists(mask_path):
            raise FileNotFoundError(f"Segmentation íŒŒì¼ ì—†ìŒ: {mask_path}")

        dicom_image = load_dicom_series(dicom_path)

        mask_image = sitk.ReadImage(mask_path)
        resampled_mask = resample_mask_to_dicom(mask_image, dicom_image)

        validate_spatial_alignment(dicom_image, resampled_mask)

        rtstruct = RTStructBuilder.create_new(dicom_series_path=dicom_path)
        mask_array = sitk.GetArrayFromImage(resampled_mask).transpose(2, 1, 0)
        mask_array = mask_array > 0  # ğŸ”¹ Boolean íƒ€ì…ìœ¼ë¡œ ë³€í™˜
        rtstruct.add_roi(mask=mask_array, name="Pancreas")

        os.makedirs(output_base, exist_ok=True)
        rtstruct.save(output_file)
        print(f"í™˜ì {patient_id} [PRE]: RTSTRUCT ìƒì„± ì„±ê³µ â†’ {output_file}")

    except Exception as e:
        print(f"í™˜ì {patient_id} [PRE]: ì˜¤ë¥˜ ë°œìƒ â†’ {str(e)}")

def main():
    print("=== RTSTRUCT ìƒì„±ê¸° (Pancreas ì „ìš©, PRE ë‹¨ê³„) ===")
    ct_base = input("CT DICOM ë£¨íŠ¸ ê²½ë¡œ: ").strip()
    seg_base = input("Segmentation ë£¨íŠ¸ ê²½ë¡œ: ").strip()
    output_base = input("ì¶œë ¥ ê²½ë¡œ: ").strip()

    mode = input("ì „ì²´ ì²˜ë¦¬(1) ë˜ëŠ” ë‹¨ì¼ í™˜ì(2): ").strip()

    if mode == '1':
        for folder in os.listdir(seg_base):
            if folder.endswith("_PRE.nii") and folder.split("_")[0].isdigit():
                pid = folder.split("_")[0]
                process_pre(pid, ct_base, seg_base, output_base)
        print("ì „ì²´ ì²˜ë¦¬ ì™„ë£Œ")
    elif mode == '2':
        pid = input("í™˜ì ID: ").strip()
        process_pre(pid, ct_base, seg_base, output_base)
    else:
        print("ì˜ëª»ëœ ì„ íƒ")

if __name__ == "__main__":
    main()
